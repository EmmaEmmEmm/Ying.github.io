<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŠ€æ²³è¡›å£« - Galaxy Defender (Final)</title>
    <style>
        body {
            background-color: #0d0d0d;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden; /* é˜²æ­¢æ»¾å‹•æ¢ */
        }

        h1 { 
            margin-bottom: 10px; 
            text-shadow: 0 0 10px #00d2ff;
        }

        #game-container {
            position: relative;
            box-shadow: 0 0 30px rgba(0, 210, 255, 0.3);
            border: 2px solid #333;
            border-radius: 4px;
        }

        canvas {
            background-color: #000;
            display: block;
        }

        .ui-panel {
            margin-top: 15px;
            text-align: center;
            width: 800px;
        }

        .info-bar {
            display: flex;
            justify-content: space-around;
            background: linear-gradient(to bottom, #333, #222);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 18px;
            border: 1px solid #444;
        }

        .stat-item span {
            color: #00d2ff;
        }

        button {
            background: linear-gradient(to bottom, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 10px 25px;
            margin: 0 5px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            box-shadow: 0 4px 0 #004494;
            transition: transform 0.1s;
        }

        button:active { 
            transform: translateY(4px); 
            box-shadow: none;
        }
    </style>
</head>
<body>

    <h1>ğŸš€ Galaxy Defender</h1>

    <div id="game-container">
        <canvas id="gameCanvas" width="800" height="500"></canvas>
    </div>

    <div class="ui-panel">
        <div class="info-bar">
            <div class="stat-item">ç‹€æ…‹: <span id="stateDisplay">READY</span></div>
            <div class="stat-item">åˆ†æ•¸: <span id="scoreVal">0</span></div>
            <div class="stat-item">ç”Ÿå‘½: <span id="livesVal">3</span></div>
            <div class="stat-item">é€Ÿåº¦: x<span id="speedVal">1.0</span></div>
        </div>
        <div class="controls">
            <button onclick="startGame()">é–‹å§‹ (Start)</button>
            <button onclick="togglePause()">æš«åœ (Pause)</button>
            <button onclick="resetGame()">é‡ç½® (Reset)</button>
            <button onclick="changeSpeed(0.1)">åŠ é€Ÿ (+)</button>
            <button onclick="changeSpeed(-0.1)">æ¸›é€Ÿ (-)</button>
        </div>
    </div>

    <script>
        // --- 1. éŠæˆ²é…ç½® ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const STATE = { OPENING: 0, READY: 1, PLAYING: 2, PAUSED: 3, GAMEOVER: 4 };

        let currentState = STATE.OPENING;
        let score = 0;
        let lives = 3;
        let speedMultiplier = 1.0;
        let frameCount = 0;
        
        const keys = { ArrowLeft: false, ArrowRight: false, Space: false };

        let bullets = [];
        let meteors = [];
        let particles = [];

        // --- 2. é¡åˆ¥å®šç¾© ---

        // ç©å®¶é£›èˆ¹ (è‡ªè¨‚è¨­è¨ˆ)
        const player = {
            x: canvas.width / 2,
            y: canvas.height - 60,
            width: 44,
            height: 44,
            speed: 6,
            
            draw: function() {
                ctx.save();
                ctx.translate(this.x, this.y);
                
                // 1. æ©Ÿç¿¼ (æ·±è—è‰²)
                ctx.fillStyle = '#0056b3';
                ctx.beginPath();
                ctx.moveTo(0, -25);
                ctx.lineTo(25, 20);
                ctx.lineTo(0, 10); // å°¾éƒ¨å…§å‡¹
                ctx.lineTo(-25, 20);
                ctx.closePath();
                ctx.fill();

                // 2. æ©Ÿèº«æ ¸å¿ƒ (äº®è—è‰²)
                ctx.fillStyle = '#00d2ff';
                ctx.beginPath();
                ctx.moveTo(0, -25);
                ctx.lineTo(8, 15);
                ctx.lineTo(-8, 15);
                ctx.fill();

                // 3. é§•é§›è‰™ (ç™½è‰²å…‰æ¾¤)
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.ellipse(0, -5, 4, 8, 0, 0, Math.PI * 2);
                ctx.fill();

                // 4. å¼•æ“ç«ç„° (å‹•æ…‹)
                if (currentState === STATE.PLAYING) {
                    ctx.fillStyle = `rgba(255, 100, 0, ${0.5 + Math.random()*0.5})`;
                    ctx.beginPath();
                    ctx.moveTo(-6, 15);
                    ctx.lineTo(0, 35 + Math.random() * 10); // ç«ç„°éš¨æ©Ÿé•·åº¦
                    ctx.lineTo(6, 15);
                    ctx.fill();
                }
                ctx.restore();
            },
            
            update: function() {
                if (keys.ArrowLeft && this.x > 25) this.x -= this.speed;
                if (keys.ArrowRight && this.x < canvas.width - 25) this.x += this.speed;
            }
        };

        // å­å½ˆé¡ (å‡ç´šç‰ˆï¼šæ”¯æ´æ–œå‘é£›è¡Œ)
        class Bullet {
            constructor(x, y, vx = 0) { // vx æ˜¯æ°´å¹³é€Ÿåº¦
                this.x = x;
                this.y = y;
                this.vx = vx; 
                this.radius = 4;
                this.speed = 8;
            }
            update() { 
                this.y -= this.speed; 
                this.x += this.vx; // è®“å­å½ˆå¯ä»¥æ–œè‘—é£›
            }
            draw() {
                ctx.fillStyle = '#fff700'; // äº®é»ƒè‰²
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#fff700';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0; // é‡ç½®é™°å½±
            }
        }

        // éš•çŸ³é¡ (åŒ…å«å…©ç¨®è¨­è¨ˆ)
        class Meteor {
            constructor() {
                this.radius = 15 + Math.random() * 25;
                this.x = Math.random() * (canvas.width - this.radius * 2) + this.radius;
                this.y = -50;
                this.speed = (1.5 + Math.random() * 2) * speedMultiplier;
                this.rotation = 0;
                this.rotationSpeed = (Math.random() - 0.5) * 0.1;
                
                // æ±ºå®šé¡å‹ï¼šå²©çŸ³ æˆ– å¤–æ˜Ÿäºº
                this.type = Math.random() > 0.6 ? 'alien' : 'rock'; 
            }
            update() { 
                this.y += this.speed; 
                this.rotation += this.rotationSpeed;
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);

                if (this.type === 'rock') {
                    // è¨­è¨ˆ 1: å²©çŸ³ (ç°è‰²å¤šé‚Šå½¢)
                    ctx.fillStyle = '#888';
                    ctx.beginPath();
                    // ç•«ä¸€å€‹ä¸è¦å‰‡çš„åœ“å½¢
                    for(let i=0; i<7; i++) {
                        let angle = (i / 7) * Math.PI * 2;
                        let r = this.radius * (0.8 + Math.random()*0.2); // è¼•å¾®æŠ–å‹•ç”¢ç”Ÿå²©çŸ³æ„Ÿ
                        ctx.lineTo(Math.cos(angle)*r, Math.sin(angle)*r);
                    }
                    ctx.closePath();
                    ctx.fill();
                    // å‘æ´ç´°ç¯€
                    ctx.fillStyle = '#555';
                    ctx.beginPath();
                    ctx.arc(this.radius*0.3, -this.radius*0.2, this.radius*0.2, 0, Math.PI*2);
                    ctx.fill();

                } else {
                    // è¨­è¨ˆ 2: å¤–æ˜Ÿæ–¹å¡Š (ç¶ è‰²ç™¼å…‰)
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = '#0f0';
                    ctx.fillStyle = '#0f0';
                    ctx.fillRect(-this.radius, -this.radius, this.radius*2, this.radius*2);
                    
                    // å¤–æ˜Ÿçœ¼ç›
                    ctx.shadowBlur = 0;
                    ctx.fillStyle = '#000';
                    ctx.fillRect(-this.radius*0.5, -this.radius*0.3, this.radius*0.4, this.radius*0.4);
                    ctx.fillRect(this.radius*0.1, -this.radius*0.3, this.radius*0.4, this.radius*0.4);
                }
                ctx.restore();
            }
        }

        // ç²’å­ç³»çµ± (çˆ†ç‚¸ç‰¹æ•ˆ)
        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                let angle = Math.random() * Math.PI * 2;
                let speed = Math.random() * 4;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.life = 1.0;
                this.color = color;
                this.decay = 0.02 + Math.random() * 0.03;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life -= this.decay;
            }
            draw() {
                ctx.globalAlpha = Math.max(0, this.life);
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1.0;
            }
        }

        // --- 3. äº‹ä»¶ç›£è½ (åŒ…å«å‰µæ„ç©æ³•è§¸ç™¼) ---
        window.addEventListener('keydown', e => {
            if (e.code === 'ArrowLeft') keys.ArrowLeft = true;
            if (e.code === 'ArrowRight') keys.ArrowRight = true;
            
            // å°„æ“Šé‚è¼¯
            if (e.code === 'Space') {
                if (currentState === STATE.PLAYING) {
                    
                    // === ã€å‰µæ„ç©æ³•ï¼šç«åŠ›å‡ç´šç³»çµ±ã€‘ ===
                    // èªªæ˜ï¼šåˆ†æ•¸ >= 50 åˆ†ï¼Œç™¼å°„ä¸‰å‘æ•£å°„å­å½ˆ
                    if (score >= 50) {
                        bullets.push(new Bullet(player.x, player.y - 20, 0));  // ä¸­é–“
                        bullets.push(new Bullet(player.x, player.y - 20, -2)); // å‘å·¦æ–œé£›
                        bullets.push(new Bullet(player.x, player.y - 20, 2));  // å‘å³æ–œé£›
                    } else {
                        // æ™®é€šå–®ç™¼
                        bullets.push(new Bullet(player.x, player.y - 20, 0));
                    }
                }
            }
        });

        window.addEventListener('keyup', e => {
            if (e.code === 'ArrowLeft') keys.ArrowLeft = false;
            if (e.code === 'ArrowRight') keys.ArrowRight = false;
        });

        // --- 4. éŠæˆ²æ ¸å¿ƒå¾ªç’° ---

        function init() {
            setTimeout(() => {
                if(currentState === STATE.OPENING) currentState = STATE.READY;
                updateUI();
            }, 3000); 
            requestAnimationFrame(gameLoop);
        }

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawStarfield(); 

            frameCount++;

            switch (currentState) {
                case STATE.OPENING:
                    drawOpening();
                    break;
                case STATE.READY:
                    player.draw();
                    drawText("æŒ‰ START é–‹å§‹éŠæˆ²", "30px Arial", "#fff", 0);
                    drawText("é”åˆ° 50 åˆ†è§£é–æœ€å¼·æ­¦å™¨ï¼", "16px Arial", "#00d2ff", 40);
                    break;
                case STATE.PLAYING:
                    updateLogic();
                    drawObjects();
                    break;
                case STATE.PAUSED:
                    drawObjects();
                    drawText("PAUSED", "50px Arial", "yellow", 0);
                    break;
                case STATE.GAMEOVER:
                    drawObjects();
                    drawText("GAME OVER", "60px Arial", "#ff3333", -20);
                    drawText(`æœ€çµ‚å¾—åˆ†: ${score}`, "24px Arial", "#fff", 40);
                    break;
            }
            
            updateUI();
            requestAnimationFrame(gameLoop);
        }

        function updateLogic() {
            player.update();

            // é›£åº¦æ§åˆ¶ï¼šåˆ†æ•¸è¶Šé«˜ï¼Œéš•çŸ³ç”Ÿæˆè¶Šå¿«
            let currentSpawnRate = Math.max(15, 80 - Math.floor(score/2)); 
            if (frameCount % currentSpawnRate === 0) {
                meteors.push(new Meteor());
            }

            // æ›´æ–°å­å½ˆ
            bullets.forEach((b, i) => {
                b.update();
                if (b.y < 0 || b.x < 0 || b.x > canvas.width) bullets.splice(i, 1);
            });

            // æ›´æ–°éš•çŸ³èˆ‡ç¢°æ’
            meteors.forEach((m, mIndex) => {
                m.update();

                // æ’åˆ°åº•éƒ¨
                if (m.y > canvas.height) {
                    meteors.splice(mIndex, 1);
                    loseLife();
                }

                // æ’åˆ°é£›èˆ¹
                const distPlayer = Math.hypot(player.x - m.x, player.y - m.y);
                if (distPlayer < player.width/2 + m.radius) {
                    createExplosion(player.x, player.y, '#ff3333');
                    meteors.splice(mIndex, 1);
                    loseLife();
                }

                // å­å½ˆæ“Šä¸­éš•çŸ³
                bullets.forEach((b, bIndex) => {
                    const distBullet = Math.hypot(b.x - m.x, b.y - m.y);
                    if (distBullet < m.radius + b.radius) {
                        // çˆ†ç‚¸ç‰¹æ•ˆé¡è‰²æ ¹æ“šæ•µäººæ”¹è®Š
                        let exploColor = m.type === 'rock' ? '#aaaaaa' : '#00ff00';
                        createExplosion(m.x, m.y, exploColor);
                        
                        meteors.splice(mIndex, 1);
                        bullets.splice(bIndex, 1);
                        score += 10;
                    }
                });
            });

            // æ›´æ–°ç²’å­
            particles.forEach((p, i) => {
                p.update();
                if (p.life <= 0) particles.splice(i, 1);
            });

            if (lives <= 0) currentState = STATE.GAMEOVER;
        }

        function drawObjects() {
            player.draw();
            bullets.forEach(b => b.draw());
            meteors.forEach(m => m.draw());
            particles.forEach(p => p.draw());
        }

        // --- 5. è¦–è¦ºç‰¹æ•ˆ ---

        function drawStarfield() {
            // èƒŒæ™¯é»‘
            ctx.fillStyle = '#050505';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // æ˜Ÿæ˜Ÿ
            ctx.fillStyle = '#fff';
            for(let i=0; i<60; i++) {
                // è®“æ˜Ÿæ˜Ÿéš¨æ™‚é–“ç·©æ…¢ç§»å‹•ï¼Œç”¢ç”Ÿè¦–å·®æ„Ÿ
                let x = (i * 113 + frameCount * 0.2) % canvas.width;
                let y = (i * 227 + frameCount * 0.5) % canvas.height;
                let size = (i % 3) + 1;
                ctx.globalAlpha = 0.5 + Math.sin(frameCount * 0.05 + i)*0.4; // é–ƒçˆ
                ctx.fillRect(x, y, size, size);
            }
            ctx.globalAlpha = 1.0;
        }

        function drawOpening() {
            let scale = 1 + Math.sin(frameCount * 0.04) * 0.2;
            let alpha = Math.min(1, frameCount / 60);

            ctx.save();
            ctx.translate(canvas.width/2, canvas.height/2);
            ctx.scale(scale, scale);
            ctx.globalAlpha = alpha;
            
            ctx.shadowBlur = 20;
            ctx.shadowColor = "#00d2ff";
            ctx.fillStyle = "#fff";
            ctx.font = "bold 50px Arial";
            ctx.textAlign = "center";
            ctx.fillText("GALAXY DEFENDER", 0, 0);
            
            ctx.font = "20px Arial";
            ctx.shadowBlur = 0;
            ctx.fillStyle = "#aaa";
            ctx.fillText("System Initializing...", 0, 50);
            
            ctx.restore();
        }

        function createExplosion(x, y, color) {
            for(let i=0; i<15; i++) { // 15å€‹ç²’å­
                particles.push(new Particle(x, y, color));
            }
        }

        function drawText(text, font, color, yOffset) {
            ctx.fillStyle = color;
            ctx.font = font;
            ctx.textAlign = "center";
            ctx.fillText(text, canvas.width/2, canvas.height/2 + yOffset);
        }

        // --- 6. æ§åˆ¶èˆ‡é‡ç½® ---
        function loseLife() {
            lives--;
            // ç•«é¢éœ‡å‹•æ•ˆæœ (ç°¡å–®ç‰ˆ)
            canvas.style.transform = "translate(5px, 5px)";
            setTimeout(() => canvas.style.transform = "translate(0, 0)", 50);
        }

        function startGame() {
            if (currentState !== STATE.PLAYING) {
                if(currentState === STATE.GAMEOVER || currentState === STATE.READY) resetGameVariables();
                currentState = STATE.PLAYING;
            }
        }

        function togglePause() {
            if (currentState === STATE.PLAYING) currentState = STATE.PAUSED;
            else if (currentState === STATE.PAUSED) currentState = STATE.PLAYING;
        }

        function resetGame() {
            currentState = STATE.READY;
            resetGameVariables();
        }

        function resetGameVariables() {
            score = 0;
            lives = 3;
            bullets = [];
            meteors = [];
            particles = [];
            player.x = canvas.width / 2;
        }

        function changeSpeed(delta) {
            speedMultiplier = Math.max(0.5, Math.min(3.0, speedMultiplier + delta));
        }

        function updateUI() {
            let stateText = Object.keys(STATE).find(key => STATE[key] === currentState);
            document.getElementById('stateDisplay').innerText = stateText;
            document.getElementById('scoreVal').innerText = score;
            document.getElementById('livesVal').innerText = lives;
            document.getElementById('speedVal').innerText = speedMultiplier.toFixed(1);
        }

        init();
    </script>
</body>
</html>